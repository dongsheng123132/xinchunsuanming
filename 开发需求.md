【产品定位 / Product Concept】
- 中文：参考 https://www.qlwy.xyz/fortune，做一个「春节开运福签」应用，核心是抽签 + AI 解签 + 送福祝福，重点是新年好运、好前程。
- English: Inspired by https://www.qlwy.xyz/fortune, build a “Lunar New Year Fortune & Blessing” app focused on drawing lots, AI interpretation, and delivering personalized good-luck blessings.

【目标用户 / Target Users】
- 中文：主要给 AI 使用（如 Claude + MCP）、也支持普通用户在网页端体验新春抽签和解签。
- English: Primarily designed for AI agents (e.g. Claude via MCP), while also supporting human users via a web UI for New Year fortune drawing and interpretation.

【平台与接入 / Platforms】
- Web 前端 / Web frontend（当前已有）：
  - 中文：使用 React + Vite + Tailwind 构建单页应用，提供摇签动画、签文展示和解签结果展示。
  - English: React + Vite + Tailwind single-page app with shaking animation, lot display, and interpretation view.
- Agent Verse / AI Agent：
  - 中文：在 https://www.agent-verse.live 注册一个服务，用作「AI 解签后端」或「AI Agent 入口」。
  - English: Register a service on https://www.agent-verse.live as the AI fortune interpretation backend or agent entrypoint.

【业务流程 / Business Flow】
1. 选择愿望方向 / Select wish category
   - 中文：用户选择一个方向，例如【事业】【财运】【感情】【健康】【家人平安】。
   - English: User selects a category such as Career, Wealth, Love, Health, or Family.

2. 摇签抽签 / Shake and draw lots
   - 中文：采用「摇签筒」交互，用户点击/触发摇动动画，每次抽出一支签。
   - English: Use a shaking-lot-tube interaction. User taps to shake and draw one lot at a time.
   - 中文：默认规则：一次会话抽 3 支签（例如 3 个签号组合）。
   - English: Default rule: 3 lots per session (a combination of three lot numbers).

3. 支付与解签 / Payment and interpretation
  - 中文：抽完 3 支签后，用户点击【解签 / Interpret】，此时需要支付 0.1 USDC（只通过 x402 支付），支付成功后返回 AI 解签结果 + 新春福卡。
  - English: After drawing 3 lots, user clicks “Interpret”. The service charges 0.1 USDC (via x402 only). Upon successful payment, AI generates the interpretation plus a New Year blessing card.

4. 福卡与分享 / Blessing card and sharing
   - 中文：每次付费解签生成一张「专属新春福卡」，内容包括：签号组合、签文、白话解读、行动建议、新年祝福语，可后续扩展为图片海报，用于分享。
   - English: Each paid interpretation creates a personalized “New Year Blessing Card” including lot numbers, verse, plain-language explanation, actionable tips, and New Year wishes. Later can be extended to an image for sharing.

【计费与支付 / Pricing and Payments】
- 单次会话价格 / Price per session：
  - 中文：0.1 USDC，一次会话包括：抽 3 支签 + 1 次完整 AI 解签 + 1 张福卡。
  - English: 0.1 USDC per session (3 lots + 1 full AI interpretation + 1 blessing card).

- 支付方式 / Payment method：
  - 中文：只支持 x402 支付（HTTP 402 Payment Required 协议），不支持传统 Web2 支付方式。
  - English: Only x402 payments are supported (HTTP 402 Payment Required). No legacy Web2 payment methods.

- 客户端角色 / Client roles：
  - 中文：前端网页可以作为「资源客户端」，也可以由 MCP Server 作为客户端去访问收费 API。
  - English: The web frontend may act as a client, and an MCP server may also act as a client to access the paid API.

【x402 协议要求 / x402 Protocol Requirements】
1. HTTP 402 流程 / HTTP 402 flow
   - 中文：解签接口为受保护资源，例如 `POST /api/fortune/interpret`。
   - English: The interpretation endpoint is a protected resource, e.g. `POST /api/fortune/interpret`.
   - 中文：当请求未附带有效 PAYMENT-SIGNATURE 头时，后端返回：
     - HTTP 状态码：402 Payment Required
     - 响应头：`PAYMENT-REQUIRED`，值为 base64 编码的 JSON（PaymentRequired 对象），包含：
      - 需支付金额（0.1 USDC）
       - 支持的 scheme（例如 exact/evm 或其他）
       - 支持的网络（例如 Base 链）及 facilitator 信息
   - English: When the request doesn’t include a valid PAYMENT-SIGNATURE header, the server must respond:
     - HTTP status: 402 Payment Required
     - Header: `PAYMENT-REQUIRED` with a base64-encoded JSON (PaymentRequired object) including:
      - Required amount (0.1 USDC)
       - Supported schemes (e.g. exact/evm or others)
       - Supported networks (e.g. Base) and facilitator info.

2. 客户端支付与重试 / Client payment and retry
   - 中文：客户端（前端、MCP Server 或其他代理）解析 `PAYMENT-REQUIRED`，根据其中的 scheme/network 要求，构造 PaymentPayload（包含签名等），base64 编码后放入 `PAYMENT-SIGNATURE` 头，再次请求同一接口。
   - English: The client (frontend, MCP server, or agent) parses `PAYMENT-REQUIRED`, builds a PaymentPayload according to the required scheme/network, base64 encodes it, and sends a new request with the `PAYMENT-SIGNATURE` header.

3. 验证与结算 / Verification and settlement
   - 中文：资源服务器可本地验证 PaymentPayload，或将 PaymentPayload 与 PaymentRequirements POST 至 x402 Facilitator 的 `/verify` 和 `/settle` 接口（推荐使用 Coinbase 提供的 x402 Facilitator 服务）。
   - English: The resource server may validate the PaymentPayload locally or POST the PaymentPayload and PaymentRequirements to the x402 facilitator’s `/verify` and `/settle` endpoints (recommended to use Coinbase’s hosted x402 facilitator).

4. 支付响应头 / Payment response header
   - 中文：支付成功并完成解签后，资源服务器返回：
     - HTTP 状态码：200 OK
     - 响应体：解签结果（签文、解读、祝福等结构化数据）
     - 响应头：`PAYMENT-RESPONSE`，值为 base64 编码 JSON，包含：
       - 支付状态（success/failed）
       - 交易哈希、网络、金额等信息（用于审计和前端展示）
   - English: After successful payment and interpretation:
     - HTTP status: 200 OK
     - Body: interpretation result (verse, explanation, blessing, etc.)
     - Header: `PAYMENT-RESPONSE` with base64-encoded JSON including:
       - Payment status (success/failed)
       - Tx hash, network, amount, etc. for logging and display.

【MCP 集成要求 / MCP Integration Requirements】
- 中文：参考 Coinbase 官方「MCP Server with x402」示例，构建一个 MCP Server，用于：
  - 暴露一个工具（例如 `get_new_year_fortune`），内部调用收费的 `/api/fortune/interpret` 接口。
  - 使用 x402 客户端逻辑（如 @x402/axios 或自定义 x402Fetch 包装）自动处理 402 + 支付握手。
  - 使用安全的钱包密钥（支持 Base 或 Solana 上的 USDC），从托管钱包或环境变量读取。
- English: Following Coinbase’s “MCP Server with x402” example:
  - Implement an MCP server exposing a tool like `get_new_year_fortune` that calls the paid `/api/fortune/interpret` endpoint.
  - Use an x402 client wrapper (e.g. @x402/axios or a custom x402Fetch) to automatically handle the 402 payment handshake.
  - Use secure wallet keys (for USDC on Base or Solana), sourced from an embedded/server wallet or environment variables.

【多语言要求 / Localization Requirements】
- 中文界面：
  - 所有主要文案（按钮、提示、标题、签文说明、祝福语）必须提供中文版本，符合新年场景，语气积极正向、不恐吓用户。
- English UI:
  - All key texts (buttons, tips, headings, explanations, blessings) must have an English version, friendly and culturally appropriate.
- 切换方式：
  - 中文：前端支持语言切换（至少在浏览器端可配置 zh / en），或根据浏览器首选语言自动选择。
  - English: Frontend should support language switching (at least zh / en) or auto-detect via browser locale.

【技术栈与实现建议 / Tech Stack and Implementation Notes】
- 前端 / Frontend：
  - React + TypeScript + Vite + Tailwind + Framer Motion（当前项目已使用）。
  - 预留 `payAndInterpretFortune` 之类的调用点，便于后续接入真正的 x402 后端。
- 后端 / Backend（资源服务器 + AI 解签逻辑）：
  - 可以使用 Node.js + TypeScript + @x402/* SDK 或 Python + x402 SDK 实现，只要完全遵守 x402 协议（HTTP 402、PAYMENT-REQUIRED、PAYMENT-SIGNATURE、PAYMENT-RESPONSE 等）。
  - AI 解签可以调用主流 LLM（如 OpenAI / Anthropic），需要根据抽签结果、愿望方向、语言偏好生成结构化解签结果。

【安全与 CDP 相关要求 / Security and CDP Notes】
- 中文：
  - 使用 Coinbase CDP 或 x402 相关 SDK 时，务必参考官方文档：https://docs.cdp.coinbase.com/
  - 所有凭证（API Key、私钥等）必须通过环境变量或安全配置管理，不得写入代码仓库。
  - 遇到 CDP/x402 报错时，优先检查 Base Configuration（网络、facilitator 配置、API Key 是否正确）。
- English:
  - When using Coinbase CDP or x402 SDKs, always follow the official docs at https://docs.cdp.coinbase.com/
  - All credentials (API keys, private keys, etc.) must be stored in environment variables or secure config, never committed to the repo.
  - On CDP/x402 errors, first verify base configuration: network, facilitator endpoint, and API key settings.

【真实 x402 支付所需准备 / What You Need for Real x402 Payments】
- 链上与资产 / On-chain assets：
  - 中文：需要一个在 Base 链上的 USDC 钱包地址，并保证余额足够支付多次 0.1 USDC 的解签费用（建议预留一部分 Gas 费）。  
  - English: You need a USDC wallet on the Base network with enough balance to cover multiple 0.1 USDC payments plus gas.

- Coinbase / CDP 配置 / Coinbase CDP configuration：
  - 中文：注册 Coinbase 账户，开通 CDP，并在 CDP 控制台中启用 x402 / Facilitator 相关配置（Base 网络、USDC）。  
  - English: Create a Coinbase account, enable CDP, and configure x402 / facilitator for USDC on Base.

- 受保护后端接口 / Protected backend API：
  - 中文：需要实现一个后端资源服务器（如 Node.js 或 Python），暴露 `POST /api/fortune/interpret`，完整遵守前文的 x402 协议流程（402 + PAYMENT-REQUIRED / PAYMENT-SIGNATURE / PAYMENT-RESPONSE），并在支付结算成功后根据 Base 上的 USDC 交易 `txHash` 生成三支签号。  
  - English: Implement a backend resource server (Node.js or Python) exposing `POST /api/fortune/interpret`, fully following the x402 flow and deriving the three lot numbers from the USDC txHash on Base after successful settlement.

- 环境变量与密钥管理 / Environment variables and secrets：
  - 中文：建议在后端项目中约定以下环境变量名称，并通过本地 `.env` 或部署平台的 Secret 进行配置：  
    - `EVM_PRIVATE_KEY`：用于支付的 Base USDC 钱包私钥（切勿提交到 GitHub）。  
    - `X402_FACILITATOR_URL`：Base 网络的 x402 Facilitator 入口地址（例如官方提供的 Base Facilitator URL）。  
    - `BASE_USDC_CONTRACT`：Base 上 USDC 合约地址。  
    - `AI_API_KEY`：用于调用 LLM（如 OpenAI/Anthropic）的 API Key。  
  - English: Recommended backend environment variables (configured via `.env` or platform secrets, never committed):  
    - `EVM_PRIVATE_KEY`: private key for the USDC wallet on Base.  
    - `X402_FACILITATOR_URL`: x402 facilitator URL for Base.  
    - `BASE_USDC_CONTRACT`: USDC contract address on Base.  
    - `AI_API_KEY`: API key for the LLM provider (OpenAI/Anthropic, etc.).

- GitHub 仓库与 Secret / GitHub repo and secrets：
  - 中文：在提交到 GitHub 前，请确保 `.gitignore` 中已忽略 `.env` / `.env.*` 等本地配置文件，所有敏感信息通过 GitHub Secrets 或部署平台 Secret 管理，不直接写入仓库。  
  - English: Before pushing to GitHub, make sure `.env` / `.env.*` files are git-ignored and all sensitive values are stored in GitHub Secrets or deployment platform secrets, never in the repository.
